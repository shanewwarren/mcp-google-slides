#!/bin/bash
# Fresher CLI
# Main command-line interface for Fresher

set -e

#──────────────────────────────────────────────────────────────────
# Directory Setup
#──────────────────────────────────────────────────────────────────

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRESHER_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
PROJECT_DIR="$(cd "$FRESHER_DIR/.." && pwd)"

#──────────────────────────────────────────────────────────────────
# Colors
#──────────────────────────────────────────────────────────────────

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

#──────────────────────────────────────────────────────────────────
# Help
#──────────────────────────────────────────────────────────────────

show_help() {
  cat << EOF
Fresher - AI-driven iterative development using Claude Code

Usage: fresher <command> [options]

Commands:
  plan              Run planning mode (alias for: FRESHER_MODE=planning run)
  build             Run building mode (alias for: FRESHER_MODE=building run)
  run               Run the loop (uses FRESHER_MODE from config)
  verify            Verify plan against specifications
  version           Show installed and latest versions
  upgrade           Upgrade Fresher to a new version
  help              Show this help message

Options:
  --help, -h        Show help for a command

Examples:
  fresher plan                    Start planning mode
  fresher build                   Start building mode
  fresher verify --quiet          Quick verification summary
  fresher version                 Check for updates
  fresher upgrade                 Upgrade to latest version
  fresher upgrade --check         Check for updates without installing

For more information, see: https://github.com/fresher/fresher
EOF
}

show_version_help() {
  cat << EOF
Usage: fresher version [options]

Show installed version and check for updates.

Options:
  --installed       Only show installed version
  --latest          Only show latest available version
  --help, -h        Show this help message

Examples:
  fresher version             Show both installed and latest versions
  fresher version --installed Show only installed version
EOF
}

show_upgrade_help() {
  cat << EOF
Usage: fresher upgrade [options]

Upgrade Fresher to a new version.

Options:
  --version=X.Y.Z   Upgrade to specific version (default: latest)
  --source=PATH     Upgrade from local directory instead of GitHub
  --check           Check for updates without installing
  --dry-run         Show what would be done without making changes
  --force           Skip confirmation prompt
  --help, -h        Show this help message

File Handling:
  CORE files are replaced:
    - run.sh, PROMPT.*.md, VERSION
    - lib/*, bin/*, docker/*, tests/*

  CUSTOM files are preserved:
    - AGENTS.md, hooks/*, logs/*

  MIXED files (config.sh):
    - Template replaced, your values preserved

Examples:
  fresher upgrade                      Upgrade to latest version
  fresher upgrade --check              Check for updates
  fresher upgrade --version=1.2.0      Upgrade to specific version
  fresher upgrade --source=~/fresher   Upgrade from local copy
  fresher upgrade --dry-run            Preview upgrade changes
EOF
}

#──────────────────────────────────────────────────────────────────
# Version Command
#──────────────────────────────────────────────────────────────────

cmd_version() {
  local show_installed=true
  local show_latest=true

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --installed)
        show_latest=false
        shift
        ;;
      --latest)
        show_installed=false
        shift
        ;;
      --help|-h)
        show_version_help
        exit 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
    esac
  done

  # Source upgrade library
  source "$FRESHER_DIR/lib/upgrade.sh"

  local installed_version
  installed_version=$(get_installed_version "$FRESHER_DIR")

  if [[ "$show_installed" == "true" ]]; then
    echo -e "Installed: ${GREEN}${installed_version}${NC}"
  fi

  if [[ "$show_latest" == "true" ]]; then
    local latest_version
    if latest_version=$(get_latest_version 2>/dev/null); then
      echo -e "Latest:    ${GREEN}${latest_version}${NC}"

      if [[ "$show_installed" == "true" ]]; then
        local cmp
        cmp=$(compare_versions "$installed_version" "$latest_version")
        case "$cmp" in
          0)
            echo -e "\n${GREEN}You're up to date!${NC}"
            ;;
          2)
            echo -e "\n${YELLOW}Update available!${NC} Run: fresher upgrade"
            ;;
          1)
            echo -e "\n${BLUE}You're running a newer version than the latest release.${NC}"
            ;;
        esac
      fi
    else
      echo -e "Latest:    ${YELLOW}(could not fetch)${NC}"
    fi
  fi
}

#──────────────────────────────────────────────────────────────────
# Upgrade Command
#──────────────────────────────────────────────────────────────────

cmd_upgrade() {
  local target_version=""
  local source_path=""
  local check_only=false
  local dry_run=false
  local force=false

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --version=*)
        target_version="${1#*=}"
        shift
        ;;
      --source=*)
        source_path="${1#*=}"
        shift
        ;;
      --check)
        check_only=true
        shift
        ;;
      --dry-run)
        dry_run=true
        shift
        ;;
      --force)
        force=true
        shift
        ;;
      --help|-h)
        show_upgrade_help
        exit 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
    esac
  done

  # Source upgrade library
  source "$FRESHER_DIR/lib/upgrade.sh"

  local installed_version
  installed_version=$(get_installed_version "$FRESHER_DIR")
  echo -e "Installed version: ${GREEN}${installed_version}${NC}"

  # Determine target version
  if [[ -n "$source_path" ]]; then
    # Using local source
    if [[ ! -d "$source_path" ]]; then
      echo -e "${RED}Error: Source path not found: $source_path${NC}" >&2
      exit 1
    fi

    # Try to get version from source
    local source_fresher="$source_path"
    [[ -d "$source_path/.fresher" ]] && source_fresher="$source_path/.fresher"

    if [[ -f "$source_fresher/VERSION" ]]; then
      target_version=$(cat "$source_fresher/VERSION" | tr -d '[:space:]')
    else
      target_version="local"
    fi
    echo -e "Source version:    ${GREEN}${target_version}${NC} (from $source_path)"

  elif [[ -n "$target_version" ]]; then
    # Specific version requested
    echo -e "Target version:    ${GREEN}${target_version}${NC}"

  else
    # Fetch latest version
    echo "Checking for latest version..."
    if target_version=$(get_latest_version 2>/dev/null); then
      echo -e "Latest version:    ${GREEN}${target_version}${NC}"
    else
      echo -e "${RED}Error: Could not fetch latest version${NC}" >&2
      exit 1
    fi
  fi

  # Compare versions
  if [[ "$target_version" != "local" ]]; then
    local cmp
    cmp=$(compare_versions "$installed_version" "$target_version")
    case "$cmp" in
      0)
        echo -e "\n${GREEN}Already at version ${target_version}${NC}"
        [[ "$check_only" == "true" ]] && exit 0
        [[ "$force" != "true" ]] && exit 0
        ;;
      1)
        echo -e "\n${YELLOW}Warning: Downgrading from ${installed_version} to ${target_version}${NC}"
        ;;
      2)
        echo -e "\n${GREEN}Upgrade available: ${installed_version} -> ${target_version}${NC}"
        ;;
    esac
  fi

  # Check only mode
  if [[ "$check_only" == "true" ]]; then
    exit 0
  fi

  # Confirmation prompt
  if [[ "$force" != "true" && "$dry_run" != "true" ]]; then
    echo ""
    read -p "Proceed with upgrade? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "Upgrade cancelled."
      exit 0
    fi
  fi

  # Perform upgrade
  echo ""
  if [[ -n "$source_path" ]]; then
    # Upgrade from local source
    upgrade_log "Upgrading from local source: $source_path"
    perform_upgrade "$source_path" "$FRESHER_DIR" "$dry_run"
  else
    # Download and upgrade from GitHub
    local temp_dir
    temp_dir=$(mktemp -d)
    trap "rm -rf $temp_dir" EXIT

    local tarball="$temp_dir/fresher-${target_version}.tar.gz"
    local extract_dir="$temp_dir/fresher-${target_version}"

    download_release "$target_version" "$tarball"
    mkdir -p "$extract_dir"
    extract_tarball "$tarball" "$extract_dir"

    perform_upgrade "$extract_dir" "$FRESHER_DIR" "$dry_run"
  fi

  # Show result
  if [[ "$dry_run" == "true" ]]; then
    echo -e "\n${YELLOW}Dry run complete. No changes made.${NC}"
  else
    local new_version
    new_version=$(get_installed_version "$FRESHER_DIR")
    echo -e "\n${GREEN}Upgrade complete!${NC} Now at version ${new_version}"
  fi
}

#──────────────────────────────────────────────────────────────────
# Run Command
#──────────────────────────────────────────────────────────────────

cmd_run() {
  exec "$FRESHER_DIR/run.sh" "$@"
}

cmd_plan() {
  FRESHER_MODE=planning exec "$FRESHER_DIR/run.sh" "$@"
}

cmd_build() {
  FRESHER_MODE=building exec "$FRESHER_DIR/run.sh" "$@"
}

#──────────────────────────────────────────────────────────────────
# Verify Command
#──────────────────────────────────────────────────────────────────

cmd_verify() {
  exec "$FRESHER_DIR/bin/fresher-verify" "$@"
}

#──────────────────────────────────────────────────────────────────
# Main
#──────────────────────────────────────────────────────────────────

main() {
  if [[ $# -eq 0 ]]; then
    show_help
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    plan)
      cmd_plan "$@"
      ;;
    build)
      cmd_build "$@"
      ;;
    run)
      cmd_run "$@"
      ;;
    verify)
      cmd_verify "$@"
      ;;
    version)
      cmd_version "$@"
      ;;
    upgrade)
      cmd_upgrade "$@"
      ;;
    help|--help|-h)
      show_help
      exit 0
      ;;
    *)
      echo "Unknown command: $command" >&2
      echo "Run 'fresher help' for usage information." >&2
      exit 1
      ;;
  esac
}

main "$@"
